resources:
  - repo: self

trigger:
  batch: true
  branches:
    include:
      - main
      - refs/tags/queue/abstractions/*

pr: none

variables:
  - name: BuildConfiguration
    value: release
  - name: BuildPlatform
    value: any cpu
  - name: Solution
    value: "fiskaltrust.Middleware.sln"
  - name: vmImageName
    value: "windows-latest"

jobs:
  - job: Build
    displayName: Build job
    pool:
      vmImage: $(vmImageName)

    steps:
      - task: yavt@1
        inputs:
          mode: "Multi"
          updateNuspecFiles: true
          updateBuildNumber: false
          semverVersion: "v1"
          failOnTagVersionMismatch: true

      - task: DotNetCoreCLI@2
        inputs:
          command: "restore"
          projects: "$(Solution)"
          feedsToUse: "select"
          vstsFeed: "$(NuGetFeed)"
          verbosityRestore: "minimal"
        displayName: "Restore"

      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          projects: $(Solution)
          arguments: "--configuration $(BuildConfiguration) --no-restore"

      - task: DotNetCoreCLI@2
        inputs:
          command: "test"
          projects: "**/*.UnitTest.csproj"
          arguments: "--configuration $(BuildConfiguration) --no-restore /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:Include=[fiskaltrust.*]*"
          nobuild: true
        displayName: "Run unit tests"

      - task: DotNetCoreCLI@2
        inputs:
          command: "test"
          projects: "**/*.IntegrationTest.csproj"
          arguments: "--configuration $(BuildConfiguration) --no-restore /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:Include=[fiskaltrust.*]*"
          nobuild: true
        displayName: "Run integration tests"

      - script: dotnet pack --output $(Build.ArtifactStagingDirectory) --configuration $(buildConfiguration) --no-restore
        displayName: "dotnet pack fiskaltrust.Middleware.Abstractions"
        workingDirectory: "src/fiskaltrust.Middleware.Abstractions"

      - task: PublishBuildArtifacts@1
        displayName: "Publish Artifact: drop"
        inputs:
          PathtoPublish: "$(build.artifactstagingdirectory)"
