using System;
using System.Net.Http;
using System.Security.Cryptography;
using System.Security.Cryptography.X509Certificates;
using fiskaltrust.ifPOS.v2.es;
using fiskaltrust.Middleware.SCU.ES.VeriFactu;
using fiskaltrust.Middleware.SCU.ES.VeriFactu.Soap;
using Microsoft.Extensions.Logging.Abstractions;
using Xunit;

namespace fiskaltrust.Middleware.SCU.ES.AcceptanceTest;

[Collection("VeriFactu Tests")]
public class VeriFactuAcceptanceTests : ESScuAcceptanceTestBase
{
    private readonly VeriFactuSCUConfiguration _configuration;

    public VeriFactuAcceptanceTests()
    {
        var certificateBase64 = "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";
        var certificatePassword = "1234";
        // Note: These are test/sandbox values. Update with real test certificates for actual testing
        _configuration = new VeriFactuSCUConfiguration
        {
            Nif = "TEST-NIF",
            NombreRazonEmisor = "Test Company S.L.",
            Certificate = new X509Certificate2(Convert.FromBase64String(certificateBase64.ToString()!), certificatePassword.ToString()!),
            BaseUrl = "https://prewww10.aeat.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/VerifactuSOAP",
            QRCodeBaseUrl = "https://prewww2.aeat.es"
        };
    }

    protected override IESSSCD CreateScu()
    {
        var requestHandler = new HttpClientHandler();
        requestHandler.ClientCertificates.Add(_configuration.Certificate);
        
        var httpClient = new HttpClient(requestHandler)
        {
            BaseAddress = new Uri(_configuration.BaseUrl)
        };
        httpClient.DefaultRequestHeaders.Add("AcceptCharset", "utf-8");
        
        var client = new Client(httpClient);
        return new VeriFactuSCU(client, _configuration);
    }
}
